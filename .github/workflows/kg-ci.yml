name: kg-ci

on:
  workflow_dispatch:
  push:
    paths:
      - 'kg/**'
      - 'packaging/**'
      - 'installer/**'
      - 'scripts/**'
      - 'service/openapi/**'
      - 'docs/api/**'
      - '.github/workflows/kg-ci.yml'
  pull_request:
    paths:
      - 'kg/**'
      - 'packaging/**'
      - 'installer/**'
      - 'scripts/**'
      - 'service/openapi/**'
      - 'docs/api/**'
      - '.github/workflows/kg-ci.yml'

jobs:
  hermetic-setup:
    runs-on: windows-latest
    env:
      MITIGATION_LOG: kg/reports/ci-mitigations-hermetic-setup.log
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Prepare mitigation log
        shell: pwsh
        run: |
          $logDir = Split-Path -Parent $env:MITIGATION_LOG
          if ($logDir) { New-Item -ItemType Directory -Force -Path $logDir | Out-Null }
          '' | Out-File -FilePath $env:MITIGATION_LOG -Encoding utf8
      - name: Install pip-tools
        run: pip install pip-tools
      - name: Verify Java tools (retry)
        shell: pwsh
        run: |
          $attempts = 3
          for ($i = 1; $i -le $attempts; $i++) {
            try {
              ./scripts/verify-java-tools.ps1
              $msg = "$(Get-Date -Format o) [verify-java-tools] success on attempt $i"
              Add-Content -Path $env:MITIGATION_LOG -Value $msg
              break
            } catch {
              $err = "$(Get-Date -Format o) [verify-java-tools] attempt $i failed: $($_.Exception.Message)"
              Add-Content -Path $env:MITIGATION_LOG -Value $err
              if ($i -eq $attempts) { throw }
              Start-Sleep -Seconds (5 * $i)
            }
          }
      - name: Build wheelhouse
        shell: pwsh
        run: |
          pip-compile --generate-hashes requirements.in -o requirements-lock.txt
          pip-compile --generate-hashes requirements-win.in -o requirements-win-lock.txt
          scripts/build-wheelhouse.ps1
      - name: Generate SBOM
        shell: pwsh
        run: scripts/sbom-cyclonedx.ps1
      - name: Upload mitigation log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mitigations-hermetic-setup
          path: ${{ env.MITIGATION_LOG }}
          if-no-files-found: ignore
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hermetic-artifacts
          path: |
            dist/sbom.cdx.json
            tools/versions.json
            .wheelhouse
          include-hidden-files: true

  api-surface:
    needs: hermetic-setup
    runs-on: windows-latest
    env:
      MITIGATION_LOG: kg/reports/ci-mitigations-api-surface.log
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Prepare mitigation log
        shell: pwsh
        run: |
          $logDir = Split-Path -Parent $env:MITIGATION_LOG
          if ($logDir) { New-Item -ItemType Directory -Force -Path $logDir | Out-Null }
          '' | Out-File -FilePath $env:MITIGATION_LOG -Encoding utf8
      - name: Install dependencies
        run: |
          python -m pip install -r requirements-win.txt
          python -m pip install "uvicorn[standard]"
      - name: Run API unit tests
        shell: pwsh
        run: pytest tests/api
      - name: Start API
        shell: pwsh
        env:
          EARCRAWLER_API_EMBEDDED_FIXTURE: '1'
        run: scripts/api-start.ps1 -Host 127.0.0.1 -Port 9001
      - name: Wait for API health
        shell: pwsh
        run: |
          $attempts = 6
          for ($i = 1; $i -le $attempts; $i++) {
            try {
              Invoke-RestMethod -Uri 'http://127.0.0.1:9001/health' -TimeoutSec 5 | Out-Null
              Add-Content -Path $env:MITIGATION_LOG -Value "$(Get-Date -Format o) [api-wait] health probe passed on attempt $i"
              break
            } catch {
              Add-Content -Path $env:MITIGATION_LOG -Value "$(Get-Date -Format o) [api-wait] attempt $i failed: $($_.Exception.Message)"
              if ($i -eq $attempts) { throw }
              Start-Sleep -Seconds (5 * $i)
            }
          }
      - name: Smoke test
        shell: pwsh
        run: scripts/api-smoke.ps1 -Host 127.0.0.1 -Port 9001
      - name: Stop API
        if: always()
        shell: pwsh
        run: scripts/api-stop.ps1
      - name: Upload smoke report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-smoke
          path: kg/reports/api-smoke.txt
      - name: Upload mitigation log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mitigations-api-surface
          path: ${{ env.MITIGATION_LOG }}
          if-no-files-found: ignore

  observability-health:
    needs: api-surface
    runs-on: windows-latest
    env:
      MITIGATION_LOG: kg/reports/ci-mitigations-observability-health.log
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Prepare mitigation log
        shell: pwsh
        run: |
          $logDir = Split-Path -Parent $env:MITIGATION_LOG
          if ($logDir) { New-Item -ItemType Directory -Force -Path $logDir | Out-Null }
          '' | Out-File -FilePath $env:MITIGATION_LOG -Encoding utf8
      - name: Install dependencies
        run: |
          python -m pip install -r requirements-win.txt
          python -m pip install "uvicorn[standard]"
      - name: Prepare reports directory
        shell: pwsh
        run: New-Item -ItemType Directory -Force -Path 'kg/reports' | Out-Null
      - name: Register Event Log source
        shell: pwsh
        run: |
          try {
            scripts/eventlog/register-source.ps1 -Source EarCrawler
            Add-Content -Path $env:MITIGATION_LOG -Value "$(Get-Date -Format o) [eventlog] registration succeeded"
          } catch {
            Add-Content -Path $env:MITIGATION_LOG -Value "$(Get-Date -Format o) [eventlog] registration failed: $($_.Exception.Message)"
            Write-Warning "Continuing despite Event Log registration failure"
          }
      - name: Start Fuseki stub
        shell: pwsh
        run: |
          $python = (Get-Command python).Source
          $proc = Start-Process -FilePath $python -ArgumentList '-m','tests.obs.stub_fuseki_server' -PassThru -WindowStyle Hidden
          $proc.Id | Out-File -FilePath 'kg/reports/fuseki.pid' -Encoding ascii
          Start-Sleep -Seconds 2
          Add-Content -Path $env:MITIGATION_LOG -Value "$(Get-Date -Format o) [fuseki-stub] started pid $($proc.Id)"
      - name: Start API facade
        shell: pwsh
        env:
          EARCRAWLER_FUSEKI_URL: http://127.0.0.1:3030/ds/query
          EARCRAWLER_API_EMBEDDED_FIXTURE: '1'
        run: scripts/api-start.ps1 -Host 127.0.0.1 -Port 9001
      - name: Wait for API facade health
        shell: pwsh
        run: |
          $attempts = 6
          for ($i = 1; $i -le $attempts; $i++) {
            try {
              Invoke-RestMethod -Uri 'http://127.0.0.1:9001/health' -TimeoutSec 5 | Out-Null
              Add-Content -Path $env:MITIGATION_LOG -Value "$(Get-Date -Format o) [api-wait] health probe passed on attempt $i"
              break
            } catch {
              Add-Content -Path $env:MITIGATION_LOG -Value "$(Get-Date -Format o) [api-wait] attempt $i failed: $($_.Exception.Message)"
              if ($i -eq $attempts) { throw }
              Start-Sleep -Seconds (5 * $i)
            }
          }
      - name: Fuseki health probe
        shell: pwsh
        run: scripts/health/fuseki-probe.ps1 -FusekiUrl http://127.0.0.1:3030/ds/query
      - name: API health probe
        shell: pwsh
        run: scripts/health/api-probe.ps1 -ApiHost 127.0.0.1 -Port 9001
      - name: Run canaries
        shell: pwsh
        run: scripts/canary/run-canaries.ps1 -ConfigPath canary/config.yml -ReportDir kg/reports
      - name: Stop API
        if: always()
        shell: pwsh
        run: scripts/api-stop.ps1
      - name: Stop Fuseki stub
        if: always()
        shell: pwsh
        run: |
          if (Test-Path 'kg/reports/fuseki.pid') {
            $fusekiPid = Get-Content 'kg/reports/fuseki.pid'
            Stop-Process -Id ([int]$fusekiPid) -ErrorAction SilentlyContinue
            Remove-Item 'kg/reports/fuseki.pid' -ErrorAction SilentlyContinue
          }
      - name: Upload mitigation log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mitigations-observability-health
          path: ${{ env.MITIGATION_LOG }}
          if-no-files-found: ignore
      - name: Upload observability reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: observability-reports
          path: |
            kg/reports/health-*.txt
            kg/reports/canary-summary.*
            kg/reports/watchdog-*.txt

  contract-artifacts:
    needs: observability-health
    runs-on: windows-latest
    env:
      MITIGATION_LOG: kg/reports/ci-mitigations-contract-artifacts.log
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Prepare mitigation log
        shell: pwsh
        run: |
          $logDir = Split-Path -Parent $env:MITIGATION_LOG
          if ($logDir) { New-Item -ItemType Directory -Force -Path $logDir | Out-Null }
          '' | Out-File -FilePath $env:MITIGATION_LOG -Encoding utf8
      - name: Install API contract dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml
      - name: Export OpenAPI + Postman artifacts
        shell: pwsh
        run: python scripts/api/export_contract.py
      - name: Package API contract bundle
        shell: pwsh
        run: pwsh scripts/api/package_contract.ps1
      - name: Hash contract bundle
        shell: pwsh
        run: |
          $zip = Get-ChildItem dist -Filter 'api-contract-*.zip' | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $zip) { throw "api-contract zip not found" }
          $hash = Get-FileHash $zip.FullName -Algorithm SHA256
          $msg = "$(Get-Date -Format o) [contract-bundle] $($zip.Name) SHA256=$($hash.Hash)"
          Add-Content -Path $env:MITIGATION_LOG -Value $msg
          Write-Host $msg
      - name: Upload API contract artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-contract
          path: |
            dist/api-contract-*.zip
            dist/api-contract-*/openapi.json
            dist/api-contract-*/postman_collection.json
            dist/api-contract-*/release-notes.md
      - name: Upload mitigation log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mitigations-contract-artifacts
          path: ${{ env.MITIGATION_LOG }}
          if-no-files-found: ignore

  incremental-scan:
    runs-on: windows-latest
    outputs:
      changed: ${{ steps.detect.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Guard versions
        shell: pwsh
        run: python scripts/check_versions.py
      - name: Run incremental scan
        shell: pwsh
        env:
          INCREMENTAL_SCAN_ONLY: '1'
        run: kg/scripts/ci-incremental.ps1
      - id: detect
        shell: pwsh
        run: |
          $status = Get-Content kg/reports/incremental-status.json | ConvertFrom-Json
          Write-Output "changed=$($status.changed)" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8 -Append
      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: incremental-reports
          path: kg/reports/*

  roundtrip-and-snapshots:
    needs: incremental-scan
    if: needs.incremental-scan.outputs.changed == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Guard versions
        shell: pwsh
        run: python scripts/check_versions.py
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      - name: Install Apache Jena and Fuseki
        shell: pwsh
        run: |
          $v = Get-Content tools/versions.json | ConvertFrom-Json
          $jenaVer = $v.jena
          if ($jenaVer -isnot [string]) { $jenaVer = $jenaVer.version }
          $fusekiVer = $v.fuseki
          if ($fusekiVer -isnot [string]) { $fusekiVer = $fusekiVer.version }
          New-Item -ItemType Directory -Force -Path tools | Out-Null
          $jenaArchive = "https://archive.apache.org/dist/jena/binaries/apache-jena-$jenaVer.zip"
          $jenaMirror = "https://downloads.apache.org/jena/binaries/apache-jena-$jenaVer.zip"
          try { Invoke-WebRequest -Uri $jenaArchive -OutFile jena.zip -ErrorAction Stop } catch { Invoke-WebRequest -Uri $jenaMirror -OutFile jena.zip }
          Expand-Archive jena.zip -DestinationPath tools
          Move-Item tools/apache-jena-$jenaVer tools/jena
          $fusekiArchive = "https://archive.apache.org/dist/jena/binaries/apache-jena-fuseki-$fusekiVer.zip"
          $fusekiMirror = "https://downloads.apache.org/jena/binaries/apache-jena-fuseki-$fusekiVer.zip"
          try { Invoke-WebRequest -Uri $fusekiArchive -OutFile fuseki.zip -ErrorAction Stop } catch { Invoke-WebRequest -Uri $fusekiMirror -OutFile fuseki.zip }
          Expand-Archive fuseki.zip -DestinationPath tools
          Move-Item tools/apache-jena-fuseki-$fusekiVer tools/fuseki
          $jenaPath = (Resolve-Path (Join-Path $PWD 'tools/jena')).Path
          $fusekiPath = (Resolve-Path (Join-Path $PWD 'tools/fuseki')).Path
          $env:JENA_HOME = $jenaPath
          $env:FUSEKI_HOME = $fusekiPath
          @"
          JENA_HOME=$jenaPath
          FUSEKI_HOME=$fusekiPath
          "@ | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          Test-Path (Join-Path tools/jena 'bat/riot.bat') | Out-Null
          Test-Path (Join-Path tools/jena 'bat/arq.bat') | Out-Null
      - name: Run round-trip and query snapshots
        shell: pwsh
        run: kg/scripts/ci-roundtrip.ps1
      - name: Upload SPARQL snapshots
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: sparql-snapshots
          path: kg/snapshots/*.srj
  shacl-owl-smoke:
    needs: [incremental-scan, roundtrip-and-snapshots]
    if: needs.incremental-scan.outputs.changed == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Guard versions
        shell: pwsh
        run: python scripts/check_versions.py
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      - name: Install Apache Jena and Fuseki
        shell: pwsh
        run: |
          $v = Get-Content tools/versions.json | ConvertFrom-Json
          $jenaVer = $v.jena
          if ($jenaVer -isnot [string]) { $jenaVer = $jenaVer.version }
          $fusekiVer = $v.fuseki
          if ($fusekiVer -isnot [string]) { $fusekiVer = $fusekiVer.version }
          New-Item -ItemType Directory -Force -Path tools | Out-Null
          $jenaArchive = "https://archive.apache.org/dist/jena/binaries/apache-jena-$jenaVer.zip"
          $jenaMirror = "https://downloads.apache.org/jena/binaries/apache-jena-$jenaVer.zip"
          try { Invoke-WebRequest -Uri $jenaArchive -OutFile jena.zip -ErrorAction Stop } catch { Invoke-WebRequest -Uri $jenaMirror -OutFile jena.zip }
          Expand-Archive jena.zip -DestinationPath tools
          Move-Item tools/apache-jena-$jenaVer tools/jena
          $fusekiArchive = "https://archive.apache.org/dist/jena/binaries/apache-jena-fuseki-$fusekiVer.zip"
          $fusekiMirror = "https://downloads.apache.org/jena/binaries/apache-jena-fuseki-$fusekiVer.zip"
          try { Invoke-WebRequest -Uri $fusekiArchive -OutFile fuseki.zip -ErrorAction Stop } catch { Invoke-WebRequest -Uri $fusekiMirror -OutFile fuseki.zip }
          Expand-Archive fuseki.zip -DestinationPath tools
          Move-Item tools/apache-jena-fuseki-$fusekiVer tools/fuseki
          $jenaPath = (Resolve-Path (Join-Path $PWD 'tools/jena')).Path
          $fusekiPath = (Resolve-Path (Join-Path $PWD 'tools/fuseki')).Path
          $env:JENA_HOME = $jenaPath
          $env:FUSEKI_HOME = $fusekiPath
          @"
          JENA_HOME=$jenaPath
          FUSEKI_HOME=$fusekiPath
          "@ | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          Test-Path (Join-Path tools/jena 'bat/riot.bat') | Out-Null
          Test-Path (Join-Path tools/jena 'bat/arq.bat') | Out-Null
      - name: Run SHACL and OWL smoke tests
        shell: pwsh
        run: kg/scripts/ci-shacl-owl.ps1
      - name: Upload SHACL/OWL reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: shacl-owl-reports
          path: kg/reports/*
  inference-smoke:
    needs: [incremental-scan, roundtrip-and-snapshots, shacl-owl-smoke]
    if: needs.incremental-scan.outputs.changed == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install CLI dependencies
        run: python -m pip install --disable-pip-version-check -r requirements-win.txt
      - name: Guard versions
        shell: pwsh
        run: python scripts/check_versions.py
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      - name: Install Apache Jena and Fuseki
        shell: pwsh
        run: |
          $v = Get-Content tools/versions.json | ConvertFrom-Json
          $jenaVer = $v.jena
          if ($jenaVer -isnot [string]) { $jenaVer = $jenaVer.version }
          $fusekiVer = $v.fuseki
          if ($fusekiVer -isnot [string]) { $fusekiVer = $fusekiVer.version }
          New-Item -ItemType Directory -Force -Path tools | Out-Null
          $jenaArchive = "https://archive.apache.org/dist/jena/binaries/apache-jena-$jenaVer.zip"
          $jenaMirror = "https://downloads.apache.org/jena/binaries/apache-jena-$jenaVer.zip"
          try { Invoke-WebRequest -Uri $jenaArchive -OutFile jena.zip -ErrorAction Stop } catch { Invoke-WebRequest -Uri $jenaMirror -OutFile jena.zip }
          Expand-Archive jena.zip -DestinationPath tools
          Move-Item tools/apache-jena-$jenaVer tools/jena
          $fusekiArchive = "https://archive.apache.org/dist/jena/binaries/apache-jena-fuseki-$fusekiVer.zip"
          $fusekiMirror = "https://downloads.apache.org/jena/binaries/apache-jena-fuseki-$fusekiVer.zip"
          try { Invoke-WebRequest -Uri $fusekiArchive -OutFile fuseki.zip -ErrorAction Stop } catch { Invoke-WebRequest -Uri $fusekiMirror -OutFile fuseki.zip }
          Expand-Archive fuseki.zip -DestinationPath tools
          Move-Item tools/apache-jena-fuseki-$fusekiVer tools/fuseki
          Test-Path (Join-Path tools/jena 'bat/riot.bat') | Out-Null
          Test-Path (Join-Path tools/jena 'bat/arq.bat') | Out-Null
      - name: Run inference smoke (RDFS)
        shell: pwsh
        run: kg/scripts/ci-inference-smoke.ps1 -Mode rdfs
      - name: Run inference smoke (OWL Mini)
        shell: pwsh
        run: kg/scripts/ci-inference-smoke.ps1 -Mode owlmini
      - name: Upload inference reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: inference-reports
          path: kg/reports/*

  offline-bundle-smoke:
    needs: incremental-scan
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Guard versions
        shell: pwsh
        run: python scripts/check_versions.py
      - name: Build offline bundle
        shell: pwsh
        run: scripts/build-offline-bundle.ps1
      - name: Stage mock tools for smoke test
        shell: pwsh
        run: |
          $bundle = Join-Path $PWD 'dist/offline_bundle'
          New-Item -ItemType Directory -Force -Path (Join-Path $bundle 'tools/jena/bat') | Out-Null
          New-Item -ItemType Directory -Force -Path (Join-Path $bundle 'tools/fuseki') | Out-Null
          @'
          @echo off
          setlocal EnableDelayedExpansion
          set LOC=
          :loop
          if "%1"=="" goto done
          if /I "%1"=="--loc" (
            set LOC=%2
            shift
            shift
            goto loop
          )
          shift
          goto loop
          :done
          if "%LOC%"=="" set LOC=%cd%
          if not exist "%LOC%" mkdir "%LOC%"
          echo mock-load>"%LOC%\loader.ok"
          exit /b 0
          '@ | Set-Content -Path (Join-Path $bundle 'tools/jena/bat/tdb2_tdbloader.bat') -Encoding ascii
          Copy-Item -Path (Join-Path $bundle 'tools/jena/bat/tdb2_tdbloader.bat') -Destination (Join-Path $bundle 'tools/jena/bat/tdb2.tdbloader.bat') -Force
          @'
          @echo off
          setlocal EnableDelayedExpansion
          set PORT=3030
          :loop
          if "%1"=="" goto run
          if /I "%1"=="--port" (
            set PORT=%2
            shift
            shift
            goto loop
          )
          shift
          goto loop
          :run
          set SCRIPT=%~dp0mock_fuseki.py
          if not exist "%SCRIPT%" (
            set SCRIPT=%~dp0tools\fuseki\mock_fuseki.py
          )
          py -3 "%SCRIPT%" !PORT!
          '@ | Set-Content -Path (Join-Path $bundle 'tools/fuseki/fuseki-server.bat') -Encoding ascii
          @"
          import json
          import sys
          from http.server import BaseHTTPRequestHandler, ThreadingHTTPServer
          from urllib.parse import urlparse


          class Handler(BaseHTTPRequestHandler):
              def do_GET(self):
                  parsed = urlparse(self.path)
                  if parsed.path == '/$/ping':
                      self.send_response(200)
                      self.send_header('Content-Type', 'text/plain')
                      self.end_headers()
                      self.wfile.write(b'OK')
                  elif parsed.path == '/ds/sparql':
                      self.send_response(200)
                      self.send_header('Content-Type', 'application/sparql-results+json')
                      self.end_headers()
                      payload = {
                          'head': {'vars': ['count']},
                          'results': {'bindings': [{'count': {'type': 'literal', 'value': '1'}}]},
                      }
                      self.wfile.write(json.dumps(payload).encode('utf-8'))
                  else:
                      self.send_response(404)
                      self.end_headers()

              def log_message(self, *args):
                  return


          def main(port: int) -> None:
              server = ThreadingHTTPServer(('127.0.0.1', port), Handler)
              try:
                  server.serve_forever()
              except KeyboardInterrupt:
                  pass


          if __name__ == '__main__':
              port = 3030
              args = sys.argv[1:]
              i = 0
              while i < len(args):
                  arg = args[i]
                  if arg == '--port' and i + 1 < len(args):
                      try:
                          port = int(args[i + 1])
                      except ValueError:
                          pass
                      i += 2
                      continue
                  i += 1
              main(port)
          "@ | Set-Content -Path (Join-Path $bundle 'tools/fuseki/mock_fuseki.py') -Encoding utf8
      - name: Verify bundle checksums
        shell: pwsh
        run: dist/offline_bundle/scripts/bundle-verify.ps1 -Path dist/offline_bundle
      - name: First run bootstrap
        shell: pwsh
        run: dist/offline_bundle/scripts/bundle-first-run.ps1 -Path dist/offline_bundle
      - name: Start bundle server
        shell: pwsh
        run: dist/offline_bundle/scripts/bundle-start.ps1 -Path dist/offline_bundle
      - name: Health probe
        shell: pwsh
        run: dist/offline_bundle/scripts/bundle-health.ps1 -Path dist/offline_bundle
      - name: Stop server
        shell: pwsh
        run: dist/offline_bundle/scripts/bundle-stop.ps1 -Path dist/offline_bundle
      - name: Upload offline bundle outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: offline-bundle
          path: |
            dist/offline_bundle/**
            kg/reports/bundle-smoke.txt
  api-contract-tests:
    needs: [incremental-scan, inference-smoke]
    if: needs.incremental-scan.outputs.changed == 'true'
    runs-on: windows-latest
    env:
      VCR_RECORD_MODE: none
      PYTEST_ALLOW_NETWORK: '0'
    steps:
      - uses: actions/checkout@v4
      - name: Guard versions
        shell: pwsh
        run: python scripts/check_versions.py
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: pip install -r requirements-win.txt
      - name: Run API contract tests
        run: pytest tests/clients tests/kg/test_ingest_contract.py
      - name: Upload cassettes
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cassettes
          path: tests/fixtures/cassettes/*.yaml

  provenance-checks:
    needs: [hermetic-setup, incremental-scan, api-contract-tests]
    if: needs.incremental-scan.outputs.changed == 'true'
    runs-on: windows-latest
    env:
      VCR_RECORD_MODE: none
      PYTEST_ALLOW_NETWORK: '0'
    steps:
      - uses: actions/checkout@v4
      - name: Download hermetic artifacts
        uses: actions/download-artifact@v4
        with:
          name: hermetic-artifacts
          path: .
          merge-multiple: true
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Guard versions
        shell: pwsh
        run: python scripts/check_versions.py
      - name: Install deps
        shell: pwsh
        run: scripts/install-from-wheelhouse.ps1
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      - name: Install Apache Jena and Fuseki
        shell: pwsh
        run: |
          $v = Get-Content tools/versions.json | ConvertFrom-Json
          $jenaVer = $v.jena
          if ($jenaVer -isnot [string]) { $jenaVer = $jenaVer.version }
          $fusekiVer = $v.fuseki
          if ($fusekiVer -isnot [string]) { $fusekiVer = $fusekiVer.version }
          New-Item -ItemType Directory -Force -Path tools | Out-Null
          $jenaArchive = "https://archive.apache.org/dist/jena/binaries/apache-jena-$jenaVer.zip"
          $jenaMirror = "https://downloads.apache.org/jena/binaries/apache-jena-$jenaVer.zip"
          try { Invoke-WebRequest -Uri $jenaArchive -OutFile jena.zip -ErrorAction Stop } catch { Invoke-WebRequest -Uri $jenaMirror -OutFile jena.zip }
          Expand-Archive jena.zip -DestinationPath tools
          Move-Item tools/apache-jena-$jenaVer tools/jena
          $fusekiArchive = "https://archive.apache.org/dist/jena/binaries/apache-jena-fuseki-$fusekiVer.zip"
          $fusekiMirror = "https://downloads.apache.org/jena/binaries/apache-jena-fuseki-$fusekiVer.zip"
          try { Invoke-WebRequest -Uri $fusekiArchive -OutFile fuseki.zip -ErrorAction Stop } catch { Invoke-WebRequest -Uri $fusekiMirror -OutFile fuseki.zip }
          Expand-Archive fuseki.zip -DestinationPath tools
          Move-Item tools/apache-jena-fuseki-$fusekiVer tools/fuseki
          Test-Path (Join-Path tools/jena 'bat/riot.bat') | Out-Null
          Test-Path (Join-Path tools/jena 'bat/arq.bat') | Out-Null
      - name: Export KG with provenance
        shell: pwsh
        run: |
          @'
          from earCrawler.kg.emit_ear import emit_ear
          from earCrawler.kg.triples import emit_tradegov_entities
          from earCrawler.kg.prov import new_prov_graph, write_prov_files
          from pathlib import Path

          g = new_prov_graph()
          fixture = Path('tests/kg/fixtures')
          emit_ear(fixture, Path('kg'), prov_graph=g)
          recs = [{
              'id': 'acme',
              'name': 'ACME Corp',
              'country': 'US',
              'source_url': 'https://trade.gov/api/acme',
              'date': '2024-01-01T00:00:00Z',
              'sha256': '0' * 64,
          }]
          emit_tradegov_entities(recs, Path('kg'), prov_graph=g)
          write_prov_files(g, Path('kg') / 'prov')
          with open('kg/ear_triples.ttl', 'w', encoding='utf-8') as f:
              f.write(Path('kg/ear.ttl').read_text())
              f.write(Path('kg/tradegov.ttl').read_text())
          '@ | python -
      - name: Run provenance checks
        shell: pwsh
        run: kg/scripts/ci-provenance.ps1
      - name: Upload provenance reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: provenance-reports
          path: kg/reports/*

  package-smoke:
    runs-on: windows-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install CLI dependencies
        run: python -m pip install --disable-pip-version-check -r requirements-win.txt
      - name: Install PyInstaller
        run: pip install pyinstaller
      - name: Build EXE
        shell: pwsh
        run: scripts/build-exe.ps1
      - name: Smoke test
        shell: pwsh
        run: |
          $exe = Get-ChildItem dist -Filter 'earctl-*-win64.exe' | Select-Object -First 1
          & $exe.FullName --version
          & $exe.FullName diagnose
      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: earctl-exe
          path: dist/earctl-*-win64.exe

  telemetry-tests:
    needs: hermetic-setup
    runs-on: windows-latest
    env:
      EAR_NO_TELEM_HTTP: '1'
      PYTEST_ALLOW_NETWORK: '0'
    steps:
      - uses: actions/checkout@v4
      - name: Download hermetic artifacts
        uses: actions/download-artifact@v4
        with:
          name: hermetic-artifacts
          path: .
          merge-multiple: true
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Resolve spool path
        shell: pwsh
        run: |
          $spool = Join-Path $env:APPDATA 'EarCrawler\spool'
          "TELEMETRY_SPOOL=$spool" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
      - name: Install deps
        shell: pwsh
        run: scripts/install-from-wheelhouse.ps1
      - name: Run telemetry tests
        run: pytest tests/telemetry
      - name: Upload spool
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: telemetry-spool
          path: ${{ env.TELEMETRY_SPOOL }}
          if-no-files-found: ignore

  gc-dry-run:
    needs: [provenance-checks, telemetry-tests]
    runs-on: windows-latest
    env:
      VCR_RECORD_MODE: none
      PYTEST_ALLOW_NETWORK: '0'
    steps:
      - uses: actions/checkout@v4
      - name: Guard versions
        shell: pwsh
        run: python scripts/check_versions.py
      - name: Run GC dry-run
        shell: pwsh
        run: kg/scripts/ci-gc.ps1
      - name: Upload GC reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gc-reports
          path: kg/reports/*

  reconcile-checks:
    needs: [provenance-checks, telemetry-tests]
    runs-on: windows-latest
    env:
      VCR_RECORD_MODE: none
      PYTEST_ALLOW_NETWORK: '0'
    steps:
      - uses: actions/checkout@v4
      - name: Guard versions
        shell: pwsh
        run: python scripts/check_versions.py
      - name: Run reconciliation checks
        shell: pwsh
        run: kg/scripts/ci-reconcile.ps1
      - name: Upload reconciliation reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reconcile-reports
          path: |
            kg/reports/reconcile-summary.json
            kg/reports/reconcile-conflicts.json
            kg/reports/reconcile-ci.txt

  perf-regression:
    needs: reconcile-checks
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Guard versions
        shell: pwsh
        run: python scripts/check_versions.py
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      - name: Install Apache Jena and Fuseki
        shell: pwsh
        run: |
          $v = Get-Content tools/versions.json | ConvertFrom-Json
          $jenaVer = $v.jena
          if ($jenaVer -isnot [string]) { $jenaVer = $jenaVer.version }
          $fusekiVer = $v.fuseki
          if ($fusekiVer -isnot [string]) { $fusekiVer = $fusekiVer.version }
          New-Item -ItemType Directory -Force -Path tools | Out-Null
          $jenaArchive = "https://archive.apache.org/dist/jena/binaries/apache-jena-$jenaVer.zip"
          $jenaMirror = "https://downloads.apache.org/jena/binaries/apache-jena-$jenaVer.zip"
          try { Invoke-WebRequest -Uri $jenaArchive -OutFile jena.zip -ErrorAction Stop } catch { Invoke-WebRequest -Uri $jenaMirror -OutFile jena.zip }
          Expand-Archive jena.zip -DestinationPath tools
          Move-Item tools/apache-jena-$jenaVer tools/jena
          $fusekiArchive = "https://archive.apache.org/dist/jena/binaries/apache-jena-fuseki-$fusekiVer.zip"
          $fusekiMirror = "https://downloads.apache.org/jena/binaries/apache-jena-fuseki-$fusekiVer.zip"
          try { Invoke-WebRequest -Uri $fusekiArchive -OutFile fuseki.zip -ErrorAction Stop } catch { Invoke-WebRequest -Uri $fusekiMirror -OutFile fuseki.zip }
          Expand-Archive fuseki.zip -DestinationPath tools
          Move-Item tools/apache-jena-fuseki-$fusekiVer tools/fuseki
      - name: Generate synthetic dataset
        shell: pwsh
        run: |
          python - <<'PY'
          from perf.synth.generator import generate
          from pathlib import Path
          generate('S', Path('perf/synth/out'))
          PY
      - name: Run perf suite
        shell: pwsh
        run: kg/scripts/perf-run.ps1 -Scale S -Cold -Warm
      - name: Run perf gate
        shell: pwsh
        run: kg/scripts/perf-gate.ps1 -Scale S
      - name: Upload perf reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-reports
          path: kg/reports/*
            
  repro-smoke:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Canonical freeze
        shell: pwsh
        run: kg/scripts/canonical-freeze.ps1
      - name: Manifest
        shell: pwsh
        run: scripts/make-manifest.ps1
      - name: Validate manifest schema
        shell: pwsh
        run: |
          $code = @"
          import json, re
          from pathlib import Path
          
          manifest = json.loads(Path('kg/canonical/manifest.json').read_text(encoding='utf-8'))
          assert 'files' in manifest, "manifest missing 'files'"
          for entry in manifest['files']:
              assert set(entry.keys()) == {'path', 'size', 'sha256'}, f"unexpected keys in {entry}"
              assert re.fullmatch(r'[0-9a-f]{64}', entry['sha256']), f"invalid hash for {entry.get('path')}"
          "@
          python -c $code
      - name: Rebuild and compare
        shell: pwsh
        run: |
          Copy-Item kg/canonical/dataset.nq dataset1.nq
          Copy-Item dataset1.nq kg/snapshots/dataset.nq -Force
          $snapHashes = @{}
          Get-ChildItem kg/canonical/snapshots -Filter *.srj | ForEach-Object { $snapHashes[$_.Name] = (Get-FileHash $_.FullName -Algorithm SHA256).Hash; Copy-Item $_.FullName ("orig-" + $_.Name) }
          Remove-Item -Recurse -Force kg/canonical
          kg/scripts/canonical-freeze.ps1
          $hash1 = (Get-FileHash dataset1.nq -Algorithm SHA256).Hash
          $hash2 = (Get-FileHash kg/canonical/dataset.nq -Algorithm SHA256).Hash
          if ($hash1 -ne $hash2) { fc /b dataset1.nq kg/canonical/dataset.nq > dist/determinism-diff.txt; exit 1 }
          foreach ($k in $snapHashes.Keys) {
            $newHash = (Get-FileHash (Join-Path kg/canonical/snapshots $k) -Algorithm SHA256).Hash
            if ($snapHashes[$k] -ne $newHash) { fc /b ("orig-"+$k) (Join-Path kg/canonical/snapshots $k) > dist/determinism-diff.txt; exit 1 }
          }
  delta-summary:
    if: startsWith(github.head_ref, 'auto/delta/')
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Post delta summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const files = fs.readdirSync('kg/reports').filter(f => f.startsWith('delta-summary'));
            if (files.length) {
              const body = fs.readFileSync(`kg/reports/${files[0]}`, 'utf8');
              github.rest.issues.createComment({issue_number: context.issue.number, owner: context.repo.owner, repo: context.repo.repo, body: '```json\n'+body+'\n```'});
            }

  access-audit:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Access audit
        shell: pwsh
        env:
          EARCTL_TELEMETRY_DISABLE: '1'
        run: kg/scripts/ci-access-audit.ps1
      - name: Upload access artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: access-audit
          path: |
            kg/reports/access-audit.txt
            ${{ env.PROGRAMDATA }}\EarCrawler\audit\*.jsonl
